helperFunctions
selectApplet


/echo ############   LOAD PROFILES   ############

## Check that entries have been personalized
if !${personalizationSuccessful} && ${personalizationSuccessful} != 1
    testPersonalizeCredential
end 

## Load the credential 
/send 80300000#(837818${docType}F5${credHBK})00 9000

## Create ephemeral key
/send 8052000100 835841*5820*9000

## Authenticate user 
/send 80310002#(830C1A13A112734401560900)00 9000

## Load access control profiles
/set-var secureACP1 82${accessProfile1}${encProfile1}
/send 80320000#(${secureACP1}) *6982 # Reader authentication not provided

## Authenticate reader 
sendDataInChain 31 00 01 8359015FA27153657373696F6E5472616E736372697074A172457068656D6572616C5075626C69634B65795841040EFE2F68C2A6B215A013FFB4DCAB620FE0CECEAE90A617A223B51A712BF2FEE28475CF67E1F968F80AA16FEFEE5FA5F3A1E49C7C1B86EBF28797DC9C7D62AAF6675265717565737482A367446F635479706578186F72672E69736F2E31383031332D352E323031392E6D646C6C506572736F6E616C4461746184694C617374206E616D656A426972746820646174656A4669727374206E616D656C486F6D65206164647265737365496D616765816E506F72747261697420696D616765A367446F63547970657834636F6D2E616E64726F69642E6964656E746974795F63726564656E7469616C2E6578616D706C652E6C6962726172795F636172646C506572736F6E616C4461746182694C617374206E616D656A4669727374206E616D6565496D616765816E506F72747261697420696D61676558410475C3D597C79823776C52440A4C100B0BABEB274413AEB572E4C6FD8EFC03E0D4A53C991E49E1FFB5019DC7642BE02C19FA9317F6ADF62F1803368360114358E958483046022100EF253977EB8F830FCFE1781E216730F869E3028E4C95306E6233A8E61CF4FAB1022100B0BD82A38B9BFA7456A6D7125C9562DEFE18A43C3C5736B139FC74FEBABD13A9 9000

/send 80320000#(${secureACP1}) *9000

/set-var secureACP2 82${accessProfile2}${encProfile1}
/send 80320000#(${secureACP2}) *6982  # Invalid MAC
/set-var secureACP2 82${accessProfile2}${encProfile2}
/send 80320000#(${secureACP2}) *9000

/set-var secureACP3 82${accessProfile3}${encProfile3}
/send 80320000#(${secureACP3}) *9000

/set-var secureACP4 82${accessProfile4}${encProfile4}
/send 80320000#(${secureACP4}) *9000

/send 803A0002#(${namespace1GetSuccess})00 *9000
/send 803B0000#(${entry1AddData})00 *9000
/send 803B0100#(${encEntry1})00 *9000
/send 803B0000#(${entry2AddData})00 *9000
/send 803B0100#(${encEntry3})00 *6982  # Decryption should fail
/send 803B0100#(${encEntry2})00 *9000
/send 803B0000#(${entry3AddData})00 *6982
/send 803B0100#(${encEntry3})00 *6985
/send 803B0000#(${entry4AddData})00 *9000
/send 803B0100#(${encEntry4})00 *9000

/send 803A0002#(${namespace2})00 *9000
/send 803B0000#(${entry5AddData})00 *9000
sendDataInChain 3B 04 00 ${encryptedChunk1} 9000
sendDataInChain 3B 06 00 ${encryptedChunk2} 9000
sendDataInChain 3B 06 00 ${encryptedChunk3} 9000
sendDataInChain 3B 06 00 ${encryptedChunk4} 9000
sendDataInChain 3B 07 00 ${encryptedChunk5} 9000

/send 8040000100 82583C*9000
signingKeyBlob=${response;s6,120} 
/send 803C0000#(825820000000000000000000000000000000000000000000000000000000000000000058#(${signingKeyBlob}))00 *9000
