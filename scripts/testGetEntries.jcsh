helperFunctions
selectApplet


/echo ############   LOAD PROFILES   ############

## Check that entries have been personalized
if !${personalizationSuccessful} && ${personalizationSuccessful} != 1
    testPersonalizeCredential
end 

## Load the credential 
/send 80300000#(837818${docType}F5${credHBK})00 9000

## Create ephemeral key
/send 8052000100 835841*5820*9000

## Authenticate user 
/send 80310002#(830C1A13A112734401560900)00 9000

## Load access control profiles
/set-var secureACP1 82${accessProfile1}${encProfile1}
/send 80320000#(${secureACP1}) *6982 # Reader authentication not provided

/set-var readerAuthMessage #(A27153657373696F6E5472616E73637269707482504141414141414141414141414141414158204F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F675265717565737481A367446F6354797065706F72672E69736F31383031332E6D646C6C506572736F6E616C4461746184694C617374206E616D656A426972746820646174656A4669727374204E616D656C486F6D65204164647265737365496D616765816E506F72747261697420696D616765) 
/set-var readerAuthPubKey #(04D04A6DA54778B4A8A1BADE5318F248A9FC32E6EFE8063E368DF3FDC6CA2A9789CCCF381FE4D9706B1808EB80E5784C02941804BC6E251B5A71C345F4C1E7A752)
/set-var readerAuthSignature #(30440220189C660AF569449E51D8F612C6B628CBA69FC7B6AEFE409E91B4BD0422CADD0102200D7FCAEC7212DBF2C8036862EFB38253BCBA659DADD9F9C167417A9308E4AC7A)

## Authenticate reader 
sendDataInChain 31 00 01 8358BBA27153657373696F6E5472616E73637269707482504141414141414141414141414141414158204F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F4F675265717565737481A367446F6354797065706F72672E69736F31383031332E6D646C6C506572736F6E616C4461746184694C617374206E616D656A426972746820646174656A4669727374204E616D656C486F6D65204164647265737365496D616765816E506F72747261697420696D616765584104D04A6DA54778B4A8A1BADE5318F248A9FC32E6EFE8063E368DF3FDC6CA2A9789CCCF381FE4D9706B1808EB80E5784C02941804BC6E251B5A71C345F4C1E7A752584630440220189C660AF569449E51D8F612C6B628CBA69FC7B6AEFE409E91B4BD0422CADD0102200D7FCAEC7212DBF2C8036862EFB38253BCBA659DADD9F9C167417A9308E4AC7A 9000

/send 80320000#(${secureACP1}) *9000

/set-var secureACP2 82${accessProfile2}${encProfile1}
/send 80320000#(${secureACP2}) *6982  # Invalid MAC
/set-var secureACP2 82${accessProfile2}${encProfile2}
/send 80320000#(${secureACP2}) *9000

/set-var secureACP3 82${accessProfile3}${encProfile3}
/send 80320000#(${secureACP3}) *9000

/set-var secureACP4 82${accessProfile4}${encProfile4}
/send 80320000#(${secureACP4}) *9000

/send 803A0002#(${namespace1GetSuccess})00 *9000
/send 803B0000#(${entry1AddData})00 *9000
/send 803B0100#(${encEntry1})00 *9000
/send 803B0000#(${entry2AddData})00 *9000
/send 803B0100#(${encEntry3})00 *6982  # Decryption should fail
/send 803B0100#(${encEntry2})00 *9000
/send 803B0000#(${entry3AddData})00 *6982
/send 803B0100#(${encEntry3})00 *6985
/send 803B0000#(${entry4AddData})00 *9000
/send 803B0100#(${encEntry4})00 *9000

/send 803A0002#(${namespace2})00 *9000
/send 803B0000#(${entry5AddData})00 *9000
sendDataInChain 3B 04 00 ${encryptedChunk1} 9000
sendDataInChain 3B 06 00 ${encryptedChunk2} 9000
sendDataInChain 3B 06 00 ${encryptedChunk3} 9000
sendDataInChain 3B 06 00 ${encryptedChunk4} 9000
sendDataInChain 3B 07 00 ${encryptedChunk5} 9000

/send 8040000100 82583C*9000
signingKeyBlob=${response;s6,120} 
/send 803C0000#(825820000000000000000000000000000000000000000000000000000000000000000058#(${signingKeyBlob}))00 *9000
